# 20240315_TIL - 네트워크 계층 (2)

## TCP 패킷의 형태

IP 패킷의 헤더는 필드를 모두 합치면 20바이트이고, TCP 세그먼트의 헤더 역시 20바이트이다. 인터넷 위 대부분의 데이터그램들은 TCP 세그먼트를 담고 있어 `TCP 패킷`이라고 한다. 따라서 `TCP 패킷`에는 기본적으로 40바이트의 공간이 차있다.

데이터그램은 이 패킷을 담고 있다. 여기에는 다음과 같은 필드가 존재한다.

- IP 프로토콜의 `버전`
- 네트워크 상에 존재하다 사라지는 `잔여 수명`
- `상위 계층의 프로토콜(TCP / UDP)`
- `데이터`
- `전송자 IP 주소(32비트)`
- `수신자 IP 주소(32비트)`

## IP 주소와 할당 방식

### IP 주소 - IPv4

32비트짜리의 주소 체계를 갖는 고유한 숫자다. 한 비트마다 2개(0과 1)의 정보를 가지므로 2^32만큼의 주소를 가진다.

- IP 주소는 특정 호스트 안에 들어있는 `NIC(Network Interface Card)`를 지칭하는 주소다.
- 라우터는 여러 개의 NIC를 가지고 여러 네트워크에 연결되어 있다.
- 우리가 알고 있는 IP 주소(12.34.XXX.XXX) 등은 32비트짜리 IP 주소를 8비트씩 끊어서 10진수로 변경한 것이다.

### 인터넷

우리가 아는 네트워크에는 2가지 종류가 있다. 하나는 호스트들 간에 묶여 있는 `LAN(Local Area Network)`이고, 라우터를 통해 LAN 간을 연결하는 `WAN(Wide Area Network)`가 있다. 

인터넷은 `inter-` + `network`를 의미한다. 위와 같은 두 개 이상의 네트워크가 연결된 형태다. 

중요한 점은 호스트가 아니라 인터넷이 연결된 것이라는 점이다. 따라서 네트워크 자체의 주소는 필요 없다. 네트워크는 하나의 큰 지도일 뿐이다.

### Scalability Challenge

포워딩 테이블에서 IP 주소의 범위에 따라 이 테이블의 크기가 기하급수적으로 늘어난다고 말한 적이 있다. 그렇기 때문에 IP 주소는 적당히 조절되어서 배정 되어야 한다. 만약 그렇지 않으면 큰 테이블을 도느라 포워딩 속도가 느려질 것이기 때문이다. 스케일이 커짐으로 인한 문제점을 `Scalability Challenge`라고 말한다.

### Hierarchical Addressing

IP 주소는 위와 같은 스케일 문제를 피하기 위해 계층화된 방식으로 구성된다.

- 32비트의 IP 공간은 임의의 두 구역으로 나뉜다.
- 앞부분은 네트워크 ID로, 같은 네트워크에 속하는 호스트들은 같은 네트워크 아이디를 가진다. `서브넷 ID` 혹은 `IP Prefix`라고 한다.
- 뒷부분은 네트워크 안에 속한 호스트 ID로, 해당 네트워크 내 어떤 NIC에 속하는지 지칭한다.

이러면 같은 네트워크 상의 호스트들은 서브넷 부분이 같아지므로, 주소도 단순화해서 표현 가능하고 포워딩 테이블의 크기도 작아진다. 새로운 호스트가 추가될 때도 부담이 덜하다.

### 서브넷

네트워크를 작은 sub-network로 분할하여 각각의 서브넷에는 고유한 IP 주소 범위가 할당된다. 즉 같은 prefix를 갖는 호스트들의 집합을 말한다. 서브넷 내의 호스트들은 라우터를 거치지 않고 접근 가능하다. 

cf) `LAN` 

지리적으로 제한된 영역(Local) 내에 있는 호스트들을 연결하는 네트워크. 서브넷과는 다른 개념이다. 단 한 LAN은 하나의 서브넷을 사용하고, 라우터를 거치지 않고 접근 가능하다. 

라우터는 여러 개의 NIC를 가지고 있고, 따라서 여러 개의 IP 주소를 가진다. 즉 라우터는 여러 서브넷에 걸쳐서 각 서브넷 간의 통신을 가능하게 한다.

### 서브넷 마스크

네트워크 ID를 기계가 이해하도록 비트맵으로 표현한 것을 말한다. IP 주소 중에서 어디까지가 서브넷 ID에 해당하는지 나타내는 것이다. 

```jsx
12.34.158.5 -> 00001100 / 00100010 / 10011110 / 00000101
255.255.255.0 -> 11111111 / 11111111 / 11111111 / 00000000
subnet mask: 1로 표현된 부분이 prefix에 해당
```

### Classful Addressing

예전에는 IP 주소를 8비트씩 고정된 클래스로 나눠서 표현했다(`/8`, `/16`, `/24` 등). 그러나 이 방식은 8비트 내에서 표현이 부족할 수 있으므로 개선안이 필요했다.

### Classless Inter-Domain Routing(CIDR)

클래스로 나누지 않고 prefix를 이용한다. 네트워크 크기에 맞게 유동적으로 설정할 수 있다(`/15` → 15번째 주소까지 prefix).

## NAT

`NAT(Network Address Translation)`는 IPv4의 주소 공간 하나를 여러 호스트가 공유하면서 사용하도록 하는 일종의 트릭이다.

IPv4는 32비트의 주소 체계를 가진다. 그래서 총 2^32개의 호스트가 사용할 수 있다. 그런데 인터넷 보급률이 올라가면서 할당할 주소가 부족해지기 시작했다.

이에 대비해 IPv6의 128비트 주소 체계가 도입되었지만 아직 본격적인 사용되고 있지는 못하다. 이에 대비하기 위해 한정된 IPv4의 주소를 효율적으로 사용하기 위해 `NAT`가 도입되었다.

- 서브넷 안의 호스트들은 고유한 IP 주소가 있다. 이때 이 IP 주소는 내수용으로 라우터를 통한 외부의 통신에는 사용되지 못한다.
- 서브넷 너머의 외부와 통신할 때는 `게이트웨이 라우터`를 거쳐 전 세계적으로 고유한 IP 주소로 변경된다. `게이트웨이 라우터`가 바로 NAT 역할을 수행한다.
- IP 주소가 바뀔 때 포트 번호 역시 변경된다. 왜냐하면 한 서브넷에서 여러 호스트가 같은 포트 번호를 사용할 수도 있기 때문이다.

즉, 외부에서 볼 때 한 서브넷 내의 호스트들은 같은 IPv4 주소를 갖는다. 그러나 게이트웨이 라우터를 지나면서 내부 호스트들은 각자 다른 주소를 가진 것으로 보인다.