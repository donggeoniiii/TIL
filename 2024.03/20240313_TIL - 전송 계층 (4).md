# 20240313_TIL - 전송 계층 (4)

## 혼잡 제어

네트워크는 하나의 연결만 존재하는 공간이 아니다. 네트워크 위에서는 수많은 호스트들이 많은 양의 데이터를 전송하고 있다. 

TCP는 송신한 패킷이 제대로 전송되지 않는 경우 패킷을 재전송한다. 이는 네트워크 혼잡을 가져오고, 네트워크 혼잡은 더 많은 재전송을 불러올 것이다.

따라서 TCP는 네트워크의 혼잡이 예상되면 데이터의 양을 줄이고, 네트워크가 널널하다고 판단되면 데이터의 양을 늘린다. 이를 TCP의 `혼잡 제어`라고 한다. 

TCP는 데이터를 수신자의 남은 버퍼 용량을 체크하는 것에 더해, 네트워크의 혼잡도도 함께 체크해서 둘 중 더 좋지 않은 쪽에 맞춰서 패킷을 보낸다.

### 네트워크 기반 혼잡 제어

네트워크의 라우터들이 전송하고 있는 데이터 량을 지속적으로 엔드 시스템에게 알려주는 방식이다. 추상적인 개념으로 구현되어 있지는 않다.

### End-End 혼잡 제어

TCP 통신을 주고받는 두 호스트의 엔드시스템들이 서로 주고 받는 ACK 피드백을 통해 혼잡도를 유추하는 방식이다.

- 만약 ACK가 오지 않거나 늦게 오면 네트워크가 혼잡하다고 판단해서 통신하는 데이터량을 줄인다.

정확한 방법은 아니지만 별 다른 방법이 없다.

> 직관적으로 설명하자면, TCP는 돌다리를 두들겨보면서 점점 세게 밟아 나가다가 깨질 것 같으면 약하게 밟는, 그런 방식이다.
> 

## TCP의 혼잡 제어 방식

### Slow Start

병목 현상을 우려해서 처음부터 많이 보내지 않는다. 먼저 적은 양의 데이터를 보내면서 시작한다. 괜찮으면 점점 전송량을 늘린다.

### Additive Increase

Threshold에 마주치면 점차 증가 속도를 늦춘다. 보통 선형으로 증가한다. 그 전까진 매 RTT마다 `최대 세그먼트 크기(Maximum Segment Size)의 제곱배`만큼 window size를 키운다. 

### Multiplicative Decrease

패킷 유실이 발견되면 전송량(==window size)을 절반으로 확 줄인다. 

패킷 유실을 발견하는 방식은 2가지가 있다. 바로 타임아웃과 3번의 중복 ACK다. 둘 중 더 심각한 상황은 타임아웃이라고 볼 수 있다. 이는 유실된 패킷 이후 모든 패킷이 정상 전송되지 않았다는 의미이기 때문이다. 

### TCP Tahoe vs Reno

TCP의 혼잡제어에는 2가지 방식이 있다.

- `TCP Tahoe`
    
    Slow Start → Threshold 넘어섬 → 선형 증가 → 패킷 유실시 무조건 증가량 1MSS로 감소 → Threshold는 유실이 발생한 시점의 절반으로 감소
    
    문제는 패킷 유실시 전송량이 태초마을로 간다는 점이다. 
    
- `TCP Reno`
    
    타임아웃이 발생하면 태초마을로 가지만 중복 ACK의 경우 패킷유실 시점 기준 절반으로 전송량을 줄인다.
    

### TDP 연결 디바이스 사이 공평성

만약 다수의 연결된 디바이스들이 하나의 링크를 공유한다면, 각 연결의 평균 전송률은 `라우터의 대역폭 / 연결 디바이스 수` 가 된다. 

모든 연결의 전송률이 여기에 가까워진다면 현재 혼잡 제어 매커니즘은 공평하다고 표현한다.