# 20240307_TIL - 어플리케이션 계층 (1)

## 소켓

어플리케이션 계층에서 서로 다른 호스트의 프로세스와 프로세스 간의 통신을 위한 API. 어플리케이션과 네트워크 사이에서 인터페이스가 된다.

### 소켓을 이용한 통신

운영체제에서 프로세스 간의 통신을 진행할 때 인터페이스인 커널을 호출하는 방식으로 진행했다. 같은 방식으로 어플리케이션은 통신을 할 때 소켓을 생성한다. 

이때 소켓의 타입은 통신 방식에 따라 달라진다. 

- 신뢰 가능한 통신 vs 빠른 속도
- 연결 지향 vs 무연결성

소켓을 생성하고 나면 어플리케이션은 소켓을 이용해 네트워크를 타 데이터를 주고 받는다.

### TCP의 통신

- 소켓의 특징
    - 신뢰할 수 있는 전송
    - 전송 데이터의 순서 보장
    - 연결 지향
    - 양방향 통신
- 통신 순서
    1. 웹 서버가 소켓 생성
    2. 특정 로컬 IP 주소와 포트에 연결
    3. 소켓 설정: Listen (통신 요청 기다리는 형태)
    4. 연결을 받을 수 있도록 Accept 설정
    5. 웹 클라이언트가 TCP 소켓 생성
    6. 핸드쉐이크를 통해 서버와 연결

### UDP의 통신

- 소켓의 특징
    - 신뢰 X 순서 보장 X
    - 무연결성, 따라서 패킷의 목적지를 명시해야 함
    - 수신자, 송신자 쌍에 대한 정보를 저장

### Multiplexing / Demultiplexing

어플리케이션 계층에 있는 프로세스들은 각자의 소켓을 가지고 있다. 그리고 이 소켓을 통해 전송계층으로 메시지를 보낸다. 전송 계층은 이 메시지를 `세그먼트`로 캡슐화 해서 하위 계층으로 내린다. 

이렇게 여러 경로로 내려온 메시지를 세그먼트로 만들어서 그때그때 하위 계층으로 내려가는 작업을 `멀티플렉싱`이라고 한다.

반대로 프로세스부터 세그먼트를 받고 메시지를 뽑아서 상위 계층으로 보내는 과정을 `디멀티플렉싱`이라고 한다.

이 두 과정은 한 경로로 들어온 데이터를 수많은 경로 중 하나의 알맞은 장소로 보내는 과정이다. 이를 결정하는 것은 데이터가 포함된 `세그먼트`에 담긴 헤더 정보에서 볼 수 있다.

1. 발신 호스트가 TCP/UDP를 통해 메시지를 보내기 위해 여러 개의 소켓에서 데이터를 모은다.
2. 헤더와 함께 하나로 묶는다. (여기까지 멀티플렉싱)
3. 하위 계층을 통해 수신 호스트로 전송한다.
4. 수신 측 네트워크 계층에서 일렬로 메시지를 전송 계층으로 전달한다.
5. 전송 계층에서 헤더를 붙여서 세그먼트에 캡슐화하고 네트워크 계층으로 보낸다.
6. 어플리케이션에서 헤더를 열고 알맞은 소켓으로 보낸다. (여기까지 디멀티플렉싱)

정리하면, 멀티플렉싱은 여러 개의 input(데이터)을 하나의 output(세그먼트)으로, 디멀티플렉싱은 하나의 input(세그먼트)을 여러 개의 output(데이터)으로 나타내는 형태다. 

### 각 계층별 운반 단위

`세그먼트`는 전송계층에서 실질적인 데이터 전송을 위해 데이터를 일정 크기로 나눈 단위다. 발신/수신 포트번호, 오류 검출을 위한 체크섬, 프레임 체크용 시퀀스 넘버 등이 붙는다.

`패킷`은 네트워크 계층에서 데이터를 목적지까지 전송하기 위해, 세그먼트에 출발지와 목적지의 논리주소(IP 주소)를 붙인 단위다. 즉 데이터에 IP 헤더가 붙은 구조다.

네트워크 계층은 UDP에서는 `IP 데이터그램`이라는 단위를 통해 데이터를 전송한다. 여기에는 출발지와 목적지의 IP 주소와 포트 넘버가 포함된다. 

각각의 데이터그램은 하나의 전송 계층 `세그먼트`를 포함한다. 호스트는 데이터그램에 들어있는 주소를 통해 알맞는 소켓으로 세그먼트를 전달한다.

### TCP와 UDP의 디멀티플렉싱

- Connection-oriented Demux
    - 연결형 디멀티플렉싱으로, TCP에서 사용한다.
    - 출발지와 목적지의 IP주소와 포트번호를 모두 사용한다.
    - 통상적으로 쓰레드(각 소켓을 담당)를 사용하는 웹 서버에서 이용하는 형태로, 서버는 각 클라이언트만을 위한 소켓을 열어둔다. 따라서 자원을 많이 사용해야 한다.
- Connectionless Demux
    - UDP의 디멀티플렉싱으로 비연결형이다.
    - 목적지 IP 주소와 포트번호만을 이용해 디멀티플렉싱이 이루어진다. 즉 출처와 상관 없이 목적지만 고려하는 형태다.