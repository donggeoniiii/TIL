# 20240318_TIL - 네트워크 계층 (3)

## Recap: NAT

- IPv4의 한계: 인터넷 보급량이 늘어나면서 이제 저거로 주소 할당 다 못함
- 그래서 서브넷 안에서는 사설 IP로 각자 다른 IP를 배정받아 사용하고, 게이트웨이 라우터에서 NAT 장치를 통해 공용 IP로 외부와 통신

### NAT의 단점

- 라우터는 네트워크 계층 포함 아래 계층만 담당하고, 따라서 IP 패킷만 다룰 수 있음. 근데 NAT는 포트 번호도 변경해야 하는데 이는 상위 계층인 전송 계층을 침범하는 것.
- NAT는 패킷을 수정할 수 없다는 end-to-end 규칙을 위반함(IP 수정)
- 로컬 환경에서는 서버 운영이 어렵다. 로컬 환경의 서버는 사설 IP를 사용하기 때문에 외부 환경의 클라이언트와 통신할 수 없다.
    - 이유는 로컬에서 외부로 나갈 때 NAT 테이블을 통해 다시 로컬 환경에서 변환해 소통하는 방식인데, 로컬 환경에 서버가 있으면 그 ‘외부’ 역시 로컬 영역이므로 진짜 외부에서 통신하는 경우는 아예 변환시킬 테이블 자체가 없다.
- 사실 IPv6를 쓰면 NAT를 안 써도 되니까 이럴 걱정이 없지만, 비용 때문에 어쩔 수 없다.

## DHCP

`동적 호스트 설정 프로토콜(Dynamic Host Configuration Protocol)`의 약자. IP를 필요로 하는 컴퓨터에게 자동 할당하고 사용하지 않으면 반환 받는 방식이다. 

마치 네트워크에 접속할 때만 랜선을 연결해서 통신하는 느낌. 그래서 `Plug and Play` 방식이라고도 한다. 일정 시간이 지나거나 네트워크에 연결할 때마다 IP가 동적으로 바뀐다.

cf) 고정 IP: 학교 네트워크 같은 로컬 환경의 경우 그냥 고정된 IP 주소를 배정해준다. 

Address Pool을 더 유연하게 사용하게 해준다. 고정 IP 방식의 10%의 주소만 가지고 같은 수의 사용자들에게 주소 배정이 가능하다.

### DHCP client-server 시나리오

1. 일단 PC를 켜면 IP 주소도, DHCP 서버도 모른다.
2. `DHCP discover`
    
    ```
    src : 0.0.0.0, X
    dest : 255.255.255.255, Y
    yiaddr: 0.0.0.0
    transaction ID : Z
    ```
    
    - `src`
        
        IP 주소를 할당받지 못한 상태로, DHCP 클라이언트로써 x번 포트에 있다는 의미다.
        
    - `dest`
        
        동일 서브넷에 있는 모든 주소로 메시지를 전송(브로드캐스트). DHCP 프로토콜 번호(Y)는 서버만 열어놓는 포트로 모든 멤버에게 전송되지만 서버만 이를 수신 가능하다.
        
    - `transaction ID`
        
        클라이언트가 랜덤으로 선택한 ID
        
3. `DHCP offer`
    
    ```
    src : 223.1.2.5, Y
    dest : 255.255.255.255, X
    yiaddr: 223.1.2.4
    transaction ID : Z
    lifetime: 3600 secs
    ...
    ```
    
    - `src`
        
        서버 자신의 IP 주소와 포트 번호. 서버가 클라이언트의 브로드캐스트에 응답해 보낸다. 
        
    - `dest`
        
        동일 서브넷에 있는 모든 주소로 메시지를 전송(브로드캐스트). 서버는 아직 통신을 받기만 했지 클라이언트가 누군지 모른다. 따라서 받은 포트 번호를 통해 통신을 보낸 사람만 받을 수 있게 한다.
        
    - `yiaddr` / `lifetime`
        - `yiaddr`: 할당하는 IP 주소
        - `lifetime`: 할당받은 IP 주소의 대여 시간
    
    `offer`에는 이 밖에도 라우터, DNS, 서브넷마스크의 IP 주소 등이 포함되어 있다. 다만 사용은 `DHCP ACK`를 받고 나서부터다.
    
4. `DHCP request` 
    
    만약 DHCP 서버가 여러 개라 브로드캐스트로 보낸 메시지에 대한 `offer`가 여러 개 온다면, 클라이언트는 이 중 하나만 선택해서 이 `request`를 보낸다. 이름이 `offer`인 이유가 있겠다.
    
    ```
    src : 0.0.0.0, X
    dest : 255.255.255.255, Y
    yiaddr: 223.1.2.4
    transaction ID : Z+1
    lifetime: 3600 secs
    ```
    
    - `src`
        
        아직 ACK를 받지 않았으므로 `offer`를 수락했어도 IP 주소가 확정되지는 않았다. 
        
    - `dest`
        
        동일 서브넷에 있는 모든 멤버에게 이 메시지를 전송 중(브로드캐스트). 이번엔 여러 개의 DHCP 서버에게 본인이 선택한 DHCP 서버의 존재를 알린다.
        
    - `yiaddr` / `lifetime`
        
        `offer`로 전달 받은 IP 주소와 대여 시간. 이를 수락한다는 의미다.
        
    - `transaction ID`
        
        처음에 클라이언트가 선택한 ID+1
        
5. `DHCP ACK`
    
    ```
    src : 223.1.2.5, Y
    dest : 255.255.255.255, X
    yiaddr: 223.1.2.4
    transaction ID : Z+1
    lifetime: 3600 secs
    ...
    ```
    
    `DHCP offer`와 동일한 내용을 다시 보낸다. `transaction ID`만 +1 해서 보낸다.
    
    클라이언트는 `ACK`를 받은 순간부터 해당 IP 주소를 사용한다.
    

### IP 단편화

데이터는 전송될 때 다수의 데이터 링크를 거친다. 이 때 보낼 수 있는 데이터의 사이즈가 링크 별로 전부 다르다. 

- `MTU(Maximum Transmission Unit)`: 각 링크가 한 번에 보낼 수 있는 데이터의 사이즈

만약 이 `MTU`보다 큰 사이즈가 들어오면 이를 `MTU` 사이즈에 맞는 프레임으로 나눈다. 이를 `IP 단편화`라고 한다. 쪼개진 데이터들은 목적지에 도착하면 다시 합쳐진다.

단 나뉠 때 쪼개지는 프레임마다 헤더 정보가 들어가야 하므로, 마지막 조각은 남은 데이터의 크기에 앞선 단편의 헤더의 크기 합(20 * n)이 포함된다.

- `ID`: 데이터를 쪼개서 저장한다.
- `fragflag`: 쪼개진 데이터 중 마지막 조각은 0으로, 나머지는 1로 설정한다. 쪼개지지 않았으면 그 자체가 마지막이니까 0이다.
- `offset`: 쪼개진 데이터 중 첫번째 값의 위치를 8로 나눈 값. 헤더의 데이터 저장 공간을 줄이기 위해 필요하다.

만약 조각 중 하나라도 유실되면 다시 합쳐지지 않는다. 그러면 나머지 데이터를 단편화된 데이터를 전부 재전송한다.