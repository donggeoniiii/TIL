# 20240322_TIL - 데이터 링크 계층 (2)

## 이더넷

처음으로 널리 사용되기 시작한 LAN 기술이다. 저렴하고 간단하다.

- `bus`
    
    노드들은 `버스`라고 하는 동일한 데이터 터널을 통해 데이터를 주고 받는다. 노선이 같아서 충돌이 발생할 수 있다.
    
    90년대 중반까지 많이 사용된 방식이다. 
    
- `star`
    
    중앙에 있는 `스위치`가 노드를 관리한다. 충돌이 발생하지 않는다. 
    
    현대에 많이 사용되는 방식이다.
    

### 이더넷의 프레임 구조

크게 데이터와 헤더, 그리고 `CRC`라는 부분으로 나뉜다. 

- 데이터에는 IP 데이터그램이 들어간다.

- 헤더에는 다음과 같은 필드들이 있다.

  - `프리앰블(preamable)`
    
      전송자와 수신자의 클럭 속도를 동기화하기 위한 64비트짜리 필드다.
    
      10101010 패턴의 7바이트와 10101011 패턴의 1바이트로 이루어져 있다. 
    
  - `src address / dest address`
    
      여기서 주소는 이더넷 주소를 의미한다.
    
      프레임은 라우터에 의해 이동된다. 라우터는 포워딩 테이블을 참조해 프레임의 dest address 필드에 다음 라우터의 MAC 주소를 갱신하면서 이를 이동시킨다.
    
  - `type`
    
      상위 계층의 프로토콜 타입이 들어간다.
    

- `CRC(Cyclic Redundancy Check at receiver)`는 에러 탐지 또는 복구에 사용되는 필드다.

### 이더넷의 MAC 프로토콜

이더넷은 `CSMA/CD` 프로토콜을 이용해 충돌을 방지한다. 

- 다른 어댑터가 전송 중임을 감지하면 전송하지 않고
- 전송 중에도 다른 어댑터가 전송 중임을 감지하면 전송을 중단하고 JAM 신호를 보내며
- 재전송을 시도하기 전에도 잠시 기다린다.

거기에 정말 절묘한 타이밍에 충돌이 발생해 MAC 프로토콜이 이를 감지하지 못하는 경우에 대비해, 이더넷은 프레임의 최소 크기를 64바이트로 정해놓고 전송하도록 한다.

### ARP(Address Resolution Protocol)

MAC 주소와 IP 주소를 연결하는 프로토콜이다. `ARP`는 IP 주소와 MAC 주소를 일대일로 매칭 시켜준다.

호스트 간의 통신에는 목적지 주소를 IP 주소를 통해 잡는데, 실제 데이터 이동 시에는 MAC 주소도 이용한다. 여기서 ARP가 사용된다.

- MAC 주소는 48비트로 이루어져 있는데, 이 중 앞의 24비트는 제조회사, 뒤에 24비트가 NIC의 고유 번호다. 따라서 MAC 주소는 NIC가 만들어지는 순간 변하지 않는 값이다.
    
    → 그럼 MAC 주소를 바꾼다는 말은 뭘까? NIC에서 나가는 MAC 프레임의 src 주소가 바뀌는 것을 말한다.
    

### ARP Table

NIC를 떠난 프레임은 src IP 주소와 dest IP 주소(IP 데이터그램 안에 있음), 그리고 출발하는 NIC의 MAC 주소를 가지고 있다. 그러므로 목적지의 MAC 주소만 알아내면 도착할 수 있다.

각 NIC 안에는 `ARP 테이블`이 있고 IP 주소에 대응하는 MAC 주소가 써있다. 만약 여기에 없다면 이를 채워야 하는데, 이때 `ARP 프로토콜`이 필요하다.

ARP 프로토콜은 테이블에 찾는 MAC 주소가 없으면 ARP Request 프레임을 LAN 전체에 브로드캐스트한다. 그럼 목적지가 될 게이트웨이 라우터가 자기 MAC 주소를 알려준다.

ARP 테이블의 정보는 일정 시간 후 소멸되는 캐시로 필요한 정보가 없어지면 다시 이 과정을 반복한다.