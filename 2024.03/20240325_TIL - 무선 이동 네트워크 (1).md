# 20230325_TIL - 무선 이동 네트워크(1)

## Intro: 무선 통신의 시대

지금까지 배운 통신 상황은 모두 유선 케이블이라는 물리적인 링크가 존재한 상황을 가정했다. 그러나 현재 우리는 수많은 무선 링크를 통한 네트워크 통신을 사용하고 있다.

- 무선 전화의 사용자 수는 이제 유선 전화 사용자 수의 5배를 능가
- 전화 뿐만 아니라 인터넷 기능을 제공하는 전자기기의 수도 이제 무선의 수가 유선을 따라잡음
- 이를 가능하게 하기 위해서 두 가지 큰 난관이 존재했다
    - wireless, 말 그대로 선 없이 가능한 통신
    - mobility, 주소를 넘나들어도 문제 없는 통신 상태
    
    두 가지 개념은 비슷하지만 분명히 지향하는 목표가 다르다.
    

## Wireless

### 무선 네트워크의 요소

사실 우리 일상에서 실제로 무선 네트워크가 필요한 부분은, 우리가 보는 결과가 나오기까지 전체 과정에서 보자면 극히 일부다. 잘 생각해보면 우리가 사용하는 전자기기라는 호스트에서 첫 라우터로 이어지는 링크까지만 단 한 번 잘 연결되면 된다(single hop). 그 후는 물리적으로 연결되어 있다.

따라서 무선 네트워크라고 해서 네트워크적인 인프라가 A부터 Z까지 다르냐면 그건 아니다. 물론 이에 대해서도 예외가 없는 건 아니지만 극히 일부다.

- ex) 아프리카에서 살아남기 위해 통신이 필요한 경우 - 기지국도 없고 랜선도 없음

### 무선 데이터 링크의 특징

우리가 이전에 사용하던 유선 케이블의 경우 물리적으로 외부로부터 완전히 차단되어 있다. 

그러나 무선은 다른 신호의 간섭이 존재한다. 간섭은 거리가 늘어남에 따라 더 많아지게 되고 점점 정보 전달을 어렵게 한다. 이는 다중 통신 환경에서 추가적인 문제를 일으킨다.

1. A, B, C 3명의 호스트가 있다. 그 중 A와 B, B와 C는 소통이 가능하지만 A와 C는 들리지 않는 거리라고 하자.
2. A와 C가 동시에 B에게 메시지를 보낸다. 원래대로라면 CSMA/CD MAC 프로토콜에 의해 Carrier Sense로 다른 호스트가 전송 중임을 알아야 한다.
3. 그러나 A와 C는 서로의 메시지를 듣지 못하는 거리에 있다. 결국 충돌이 발생해도 A와 C는 아무 역할도 하지 못한다.

위와 같은 문제를 `hidden terminal 문제`라고 한다. 

여러 호스트가 모두 서로의 신호를 들을 수 있는 상황이어도 문제다. 내 시그널은 내 주변에서 가장 강하게 나가므로, 다른 사람의 신호가 노이즈처럼 작게 들려버린다. 그러므로 충돌 감지가 어렵다.

## IEEE 802.11 Wireless LAN - “Wi-Fi”

‘Wireless Fidelity’의 약자다. fidelity는 기술적으로 오리지널과 복제본의 유사도가 비슷함을 의미한다. 그럼 Wi-Fi에 붙은 Fidelity의 의미는? 무선 네트워크가 유선을 사용할 때에 근접해간다는 것을 의미한다. 

### Wi-Fi의 네트워크 인프라 구조

- 무선 호스트가 접속하기 위한 `접속 포인트(Access Point, AP)`가 존재한다. AP는 이더넷으로 스위치와 연결되어 있다.
- 동일한 AP를 사용하는 하위 네트워크를 `Basic Service Set, BSS`라고 한다. 이는 무선 네트워크의 최소단위라고 볼 수 있다.
- AP들은 주기적으로 beacon 프레임을 날려 자신의 정보를 브로드캐스트로 전달한다. 비콘 프레임에는 AP의 MAC 주소 등 연결을 위한 정보가 있고, 이를 통해 호스트는 시그널의 세기도 계산할 수 있다.
    - 당장 우리가 사용하고 있는 무선 네트워크 정보를 열어보자. 수많은 Wi-Fi들이 본인의 세기와 함께 네트워크 이름, 그리고 보이진 않지만 연결하기 위한 주소 정보를 전달해주고 있다.
    - 호스트는 가만히 있고 AP만 본인의 정보를 보내는 이 상황을 `passive scanning`이라고 한다.

### Wi-Fi 링크의 MAC 프로토콜 - CSMA/CA

기존의 유선 네트워크용 CSMA/CD MAC 프로토콜은 충돌을 스스로 감지하기 때문에, 충돌이 발생하면 전송이 잘 안되었다고 간주하고 충돌을 감지하기 전까지 계속 전송한다.

그런데 무선 데이터 링크의 경우 전에 생각했던 것처럼 충돌이 더 일어나기 쉬운 환경인데, 감지는 사실상 불가능하다. 따라서 충돌로 전송 여부를 감지하지 않고, CSMA/CD 프로토콜에서는 없었던 ‘ACK’의 개념을 가져온다. 이를 `CSMA/CA`라고 하고, CA는 collision avoidance라고 한다.

### CSMA/CA의 전송 방식

- 송신자는 `DIFS`라는 정해진 시간만큼 조용해질 때까지 기다린다.
- carrier sense: 다른 호스트가 전송 중이면 random backoff를 통해 idle이 될 때까지 잠시 기다린다.
- 수신자는 `SIFS`라는 정해진 시간만큼 기다렸다가 ACK를 보낸다. 송신자는 ACK를 받을 때까지 무한 재전송한다.
    - SIFS는 DIFS보다 상대적으로 짧다(다른 호스트들의 idle 감지 후 전송을 막기 위함).

보다시피 충돌을 감지하면 멈춘다는 개념이 없다. 충돌 감지를 할 수 없기 때문이다. 충돌을 감지하면 바로 멈추는 CSMA/CD와 가장 큰 차이점이다. 유선에 비해 자원 소모가 심해서 충돌을 잘 피해야 한다.

### RTS - CTS 교환

자원 소모를 최소화 하기 위해 돌(?)을 하나 던져보는 아이디어에서 나온 방식이다.

1. 호스트는 carrier sense 후 데이터를 보내기 전에 `RTS(ready to send)`라는 아주 작은 크기의 컨트롤 프레임을 AP로 전송한다. 
2. AP는 이에 대한 응답으로 `CTS(clear to send)`를 브로드캐스팅 한다. 
3. 다른 호스트는 브로드캐스팅된 `CTS`를 보고 다른 호스트가 사용하고 있음을 알아차린다.
    - 두 `RTS`가 충돌하면, 해당 `RTS`를 보낸 호스트들은 충돌이 발생함을 감지하고 random backoff 이후에 다시 `RTS`를 던져본다.

만약 AP가 한 `RTS1`에 대한 `CTS`를 보내는 절묘한 타이밍에 다른 `RTS2`가 온다면, `CTS`와 `RTS2`가 섞여 AP는 `RTS2`에 대한 응답을 보내지 못한다. 

또한 `CTS`를 받은 호스트가 AP에 전송을 시작해도, 해당 전송은 `RTS2`로 인해 AP에겐 노이즈가 되어 ACK를 받지 못한다. 그럼 다시 사방에서 `RTS`를 전송하게 된다.

무선 네트워크에서 다른 호스트가 많아지면 전송이 안되는 원리는 이것 때문이다. 여러 호스트가 동시에 RTS를 보낼 수록 원활한 전송이 되기 어렵다. 

### Wi-Fi 프레임의 주소 필드

특이하게 헤더의 주소 필드가 src-dest의 2가지가 아니라 4가지나 된다.

- address 1: 라우터로 이 데이터를 전송할 AP의 MAC 주소
- address 2: 보내는 호스트 본인의 MAC 주소
- address 3: 라우터의 MAC 주소
- address 4: 잘 안 씀(ad hoc 모드에서 사용)

이 프레임은 무선 호스트에서 AP에 전송될 때 사용되고, AP에서 라우터로 전송될 때는 무선 통신이 아니므로 CSMA/CD를 위한 프레임에 담긴다. 거기서 src는 무선 호스트, dest는 라우터의 MAC 주소가 된다.