# 20240126_TIL - 프로세스 동기화의 개념

운영체제의 프로세스 관리 서비스 중 가장 중요한 두 가지를 꼽자면 스케줄링과 동기화가 있다. 이번엔 동기화에 대해 알아보자.

## 동기화

앞서 배운 것처럼 쓰레드 뿐만 아니라 프로세스 간에도 서로 데이터를 주고 받으며 실행될 수 있다. 그렇기 때문에 협력하여 실행되는 프로세스들은 실행 순서와 자원의 일관성을 보장해야 한다. 이를 위해 `동기화(synchronization)`이 필수적이다.

`프로세스 동기화`는 프로세스들 사이의 수행 시기를 맞추는 것을 말한다. 수행 시기를 맞춘다는 것은 곧 실행 순서 제어가 일어나거나, 동시에 접근해서는 안되는 자원에 하나의 프로세스만 접근하게 한다는 것이다.

### 실행 제어를 위한 동기화

자주 들었던 예시로 워드 프로세서를 떠올려보자. 문장을 하나 입력하려고 하기 위해서 입력을 받는 프로세스, 입력받은 문장의 맞춤법을 검사하는 프로세스, 그리고 결과를 창에 띄우는 프로세스가 존재할 것이다. 서로 다른 독립적인 프로세스지만, 워드 프로세서 내에서 입력받은 문장을 출력하기 위해 협력한다는 공통점이 있다. 

이런 프로세스들은 아무렇게나 실행되어서는 안된다. 예를 들어 아직 입력받지도 않았는데 결과를 창에 띄우는 프로세스가 실행될 수는 없을 것이다.

이렇게 동시에 실행되는 프로세스를 올바른 순서로 실행하는 것이 `실행 제어를 위한 동기화`다.

### 상호 배제를 위한 동기화

총합이 10으로 고정된 `물품 수량`이라는 변수에 1을 더하는 `생산자` 프로세스, 1을 빼는 `소비자` 프로세스가 있다고 생각해보자. 각각의 프로세스를 10만 번씩 동시에 실행시키면 어떻게 될까? 

답은 항상 10이 보장되지 않는다. 심지어 `물품 수량` 값이 음수가 될 수도 있다. 한 프로세스가 미처 `물품 수량`을 업데이트하기도 전에 문맥 교환이 일어난다면, 그 다음에 작동하는 프로세스는 잘못된 값을 참조해서 실행될 것이다.  

따라서 이 두 프로세스는 `물품 수량` 이라는 동시에 접근해서는 안되는 자원을 공유하므로, 반드시 한 프로세스가 실행되는 동안에 다른 프로세스가 실행되어서는 안된다. 이를 `상호 배제를 위한 동기화`라고 한다.

이렇게 공동으로 사용하는 자원을 `공유 자원`이라고 하고, 그 중 동시에 접근하면 문제가 생기는 공유 자원에 접근하는 코드를 `임계 구역`이라고 한다. 공유 자원은 작게는 전역 변수일 수도 있고, 크게는 파일이나 입출력장치, 보조기억장치가 될 수 있다. 만약 두 개 이상의 프로세스가 이 공유 자원에 접근하려고 하면, 한 프로세스는 반드시 대기해야 한다.

### 레이스 컨디션

상호 배제를 위한 동기화가 제대로 되지 않은 잘못된 실행으로 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하는 경우가 있다. 이 때 문제가 발생하는 것을 `레이스 컨디션(race condition)`이라고 한다. 위에서 봤던 생산자와 소비자 문제가 이 레이스 컨디션의 예시다.

이런 잘못된 실행은 왜 일어나는 것일까? 근본적인 이유는 우리가 사용하는 프로그래밍 언어에서 기계어로 변환되는 과정에서 존재한다. 

```java
/* 우리가 사용하는 프로그래밍 언어 */
total++; // 총합 1 증가

/* 변환된 기계어 */
r1 = total; // 총합 변수를 레지스터 1에 저장
total = r1 + 1; // 레지스터 1의 값에 1을 더한 값을 총합 변수에 저장
total = r2; // 레지스터 2에 계산된 총합 변수값 저장
```

우리가 보기엔 한 줄인 코드도, 기계어로 변환되었을 때는 그렇지 않다. 즉 한 줄의 코드를 처리하는 과정에서 충분히 문맥교환이 일어날 수 있는 것이다. 

이를 위해 상호 배제를 위한 동기화가 필요한 것이다. 

- `상호 배제(mutual exclution)`: 한 프로세스가 임계 구역에 접근하면 다른 프로세스는 접근 x
- `진행(progress)`: 임계 구역에 진입한 프로세스가 없으면 이번에 진입하려는 프로세스는 가능해야 함
- `유한 대기(bounded waiting)`: 한 프로세스가 임계 구역에 접근하고자 하면, 유한한 대기 시간 안에 반드시 접근할 수는 있어야 한다. 즉 접근하지 못하는 경우가 있어서는 안된다.